!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["ikarus-visualizer"]=e():t["ikarus-visualizer"]=e()}(window,(function(){return function(t){var e={};function s(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=t,s.c=e,s.d=function(t,e,r){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)s.d(r,i,function(e){return t[e]}.bind(null,i));return r},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class r{constructor(t){this.events=t instanceof r?t.events:t.handlers}on(t,e){return("string"==typeof t?t.split(" "):t).forEach(t=>{if(!this.events[t])throw new Error(`The event ${t} does not exist`);this.events[t].push(e)}),this}trigger(t,e){if(!(t in this.events))throw new Error(`The event ${t} cannot be triggered`);let s=!0,r=this;return this.events[t].forEach(t=>{"function"==typeof t&&(s=t.call(r,e)&&s)}),s}bind(t){if(this.events[t])throw new Error(`The event ${t} is already bound`);this.events[t]=[]}exists(t){return Array.isArray(this.events[t])}}class i extends r{constructor(t,e){super(e),this.id=t,this.components=new Map,this.plugins=new Map}use(t,e){if(t.name&&this.plugins.has(t.name))throw new Error(`Plugin ${t.name} already in use`);t.install(this,e||{}),this.plugins.set(t.name,e)}register(t){if(this.components.has(t.name))throw new Error(`Component ${t.name} already registered`);this.components.set(t.name,t),this.trigger("componentregister",t)}destroy(){this.trigger("destroy")}}class n extends class{constructor(t){this.handlers={warn:[console.warn],error:[console.error],componentregister:[],destroy:[],...t}}}{constructor(){super({beforeupdate:[],afterupdate:[],updatestatus:[],removealert:[],createalert:[],quitalert:[],sendcontrol:[],sentcontrol:[],sendcommand:[],sentcommand:[],sendvalue:[],sentvalue:[],callprocedure:[],procedurecalled:[]})}}class a{constructor(t,e,s,r,i,n){"string"!=typeof t&&([e,s,r,i,n]=[t.code,t.brick,t.message,t.date,t.level],t=t.uid),this.uid=t,this.code=e,this.brick=s,this.message=r,this.date=i,this.level=n,this.quitCallback=void 0}}const o=window.jQuery;let l;const u={null:()=>"-.-"};class c extends i{static get CONTROL_MANUAL_ON(){return"on"}static get CONTROL_MANUAL_OFF(){return"on"}static get CONTROL_MANUAL_AUTO(){return"on"}static get STATUS_OFF(){return 1}static get STATUS_ON(){return 2}static get STATUS_ERROR(){return 4}static get STATUS_HAND(){return 8}static get mainVisualizer(){return l}static get formatters(){return u}use(t,e){super.use(t,e),t.visualizer=this}constructor(t,e,s,r){super(s,new n),this.interval=e,l=this,this.alertMap=new Map,this.communication=t,r&&this.updateFromCommunication(!0)}updateFromCommunication(t){if(!this.communication)throw new Error("Ikarus visualizer requires a communication instance.");let e=new FormData;this.communication.post("fetch",e).success(e=>{this.updateFromJSON(e.response),t&&window.setTimeout(()=>this.updateFromCommunication(!0),this.interval)}).error(t=>{this.trigger("error",t)})}updateFromJSON(t){if(this.trigger("beforeupdate",t)){if(!o)throw new Error("Ikarus visualizer requires jQuery component.");if(t.alerts&&t.alerts.length>0){const e=[];for(const s in t.alerts){const r=t.alerts[s];if(r.uid&&(e.push(r.uid),!this.alertMap.has(r.uid))){const t=new a(r);this.alertMap.set(r.uid,t),this.trigger("createalert",t)}}this.alertMap.forEach(t=>{-1===e.indexOf(t.uid)&&(this.trigger("removealert",t),this.alertMap.delete(t.uid))})}else this.alertMap.forEach(t=>{this.trigger("removealert",t),this.alertMap.delete(t.uid)});for(const e in t)if(t.hasOwnProperty(e)){const s=o("#"+e);if(s.length<1||s.hasClass("editing"))continue;let r=t[e];if(void 0!==r){if("string"==typeof r||"number"==typeof r){r=this.formatValue(r,s.attr("data-formatter"),s[0]),s.html(r);continue}"number"==typeof r.status&&(this.trigger("updatestatus",{anID:e,status:r.status,el:s[0]}),delete r.status);for(const t in r){const e=s.find("[data-ikey='"+t+"']");e.length>0&&!e.hasClass("editing")&&e.html(this.formatValue(r[t],e.attr("data-formatter"),e[0]))}}}this.trigger("afterupdate")}}formatValue(t,e,s){if(void 0!==e&&e.length){if("@"===e.charAt(0)&&(e=e.substr(1),"function"==typeof(e=u[e])))return e(t,s);let r=1*o(s).attr("data-multiplyer");return r>1&&(t*=r),window.Skyline.String.format(e,t)}return t}sendControl(t,e){if(this.trigger("sendcontrol",t,e)){var s=new FormData;s.append("type",t),s.append("key",e),this.communication.post("ctl",s).success(t=>{this.trigger("sentcontrol",t)}).error(t=>{this.trigger("error",t)})}}sendCommand(t,e){if(this.trigger("sendcommand",t,e)){var s=new FormData;s.append("cmd",t),s.append("info",JSON.stringify(e||[])),this.communication.post("putc",s).success(t=>{this.trigger("sentcommand",t)}).error(t=>{this.trigger("error",t)})}}sendValue(t,e,s,r){if(this.trigger("sendvalue",t,e)){var i=new FormData;i.append("value",t),i.append("key",e),this.communication.post("putv",i).success(t=>{this.trigger("sentvalue",t),s&&s(t.value)}).error(t=>{this.trigger("error",t),r&&r(t)})}}callProcedure(t,e){if(this.trigger("callprocedure",t,e)){var s=new FormData;s.append("name",t),info&&s.append("arguments",JSON.stringify(e)),this.communication.post("cproc",s).success(t=>{this.trigger("procedurecalled",t)}).error(t=>{this.trigger("error",t)})}}quitAlert(t){var e=new FormData;e.append("key",t),this.communication.post("quit",e).success(e=>{this.trigger("quitalert",e);const s=this.alertMap.get(t instanceof a?t.uid:t);"function"==typeof s.quitCallback&&s.quitCallback.call(s,e)}).error(t=>{this.trigger("error",t)})}}const d={def:function(){return p(this).text()}},h={def:function(t,e){p(this).html(t)}},p=window.jQuery;let m=2500;class f{static get editableTagReaders(){return d}static get editableTagWriters(){return h}static get EDITOR_CHANGE_INTERVAL(){return m}static set EDITOR_CHANGE_INTERVAL(t){m=t}constructor(t,e){this.$element=p(t),this.$element.addClass("value-editable active"),this.visualizer=e||c.mainVisualizer,this.$element.on("dblclick touch",()=>{this.$element.addClass("editing");let e=f.editableTagReaders[this.$element[0].tagName.toLowerCase()];e||(e=f.editableTagReaders.def),this.oldValue=e.call(t);let s=this.$element.attr("data-editable");s=s||"text",this.$element.html("<input type='"+s+"' class='form-control p-0 px-1' value='"+this.oldValue+"'>"),this.$element.find("input").focus()}).on("change",()=>{this.$element.removeClass("editing");var e=this.$element.find("input").val(),s=this.$element.attr("id");let r=f.editableTagWriters[this.$element[0].tagName.toLowerCase()];r||(r=f.editableTagWriters.def);let i=()=>{this.$element.removeClass("sending").addClass("error"),window.setTimeout(()=>{this.$element.removeClass("error")},f.EDITOR_CHANGE_INTERVAL),r.call(t,this.oldValue,!1)},n=e=>{this.$element.removeClass("sending").addClass("success"),window.setTimeout(()=>{this.$element.removeClass("success")},f.EDITOR_CHANGE_INTERVAL),void 0!==e&&r.call(t,e,!0)};s?(this.$element.addClass("sending"),this.visualizer.sendValue(e,s,n,i)):(console.error("Can not put value without attribute id",this.$element[0]),i()),this.$element.blur()})}}class g{constructor(){this.successFN=[],this.errorFN=[]}post(t,e){this.errorFN=[],this.successFN=[]}success(t){return this.successFN.push(t),this}error(t){this.errorFN.push(t)}_trigger(t,...e){t.forEach(t=>{t(...e)})}}const w=window.Skyline.API;class v extends g{constructor(t,e){super(),this.domain=e,this.targetURL=t}post(t,e){return e.append("domain",this.domain),e.append("command",t),w.post(this.targetURL,e)}}class b{get name(){return""}install(t,e){}}const y=window.jQuery;class C extends b{install(t,e){t.on("updatestatus",({anID:t,status:e,el:s})=>this.statusHandler(t,e,s))}statusHandler(t,e,s){const r=y(s);r.removeClass("status-on").removeClass("status-off").removeClass("status-hand").removeClass("status-err"),e&c.STATUS_OFF&&r.addClass("status-off"),e&c.STATUS_ON&&r.addClass("status-on"),e&c.STATUS_ERROR&&r.addClass("status-err"),e&c.STATUS_HAND&&r.addClass("status-hand")}}class T extends C{statusHandler(t,e,s){const r=s=>{super.statusHandler(t,e&~c.STATUS_HAND,s)};$(s).parent().find(".brick[data-master='"+t+"']").each((function(){r(this)}))}}const A=window.jQuery;class k extends b{install(t,e){if(!A)throw new Error("Can not install value edition plugin without jQuery installed before.");A("span[data-editable]").each((function(){this.value_editor=new f(this,t)}))}}const E=window.jQuery;class N extends b{install(t,e){if(!E)throw new Error("Can not install brick panel plugin without jQuery installed before.");E(".brick[data-panel]").on("click",(function(){let e=E("#"+E(this).attr("data-panel")).html();e=e.replace(/&amp;id;/gi,E(this).attr("id")),e=e.replace(/&amp;info;/gi,E(this).attr("data-info")),e=e.replace(/&amp;domain;/gi,E(this).attr("data-domain")),e+=' <button type="button" onclick="$(this).parent().parent().popover(\'hide\')" class="close" style="position: absolute; top: 0.25rem; right: 0.25rem" aria-label="Close">\n  <span aria-hidden="true">&times;</span>\n</button>';const s=this.id;e=E(e),e.find("button[data-control]").on("click",(function(){t.sendControl(E(this).attr("data-control"),s)})),E(e).find("button").attr("disabled","disabled"),(E(this).hasClass("status-on")||E(this).hasClass("status-off"))&&E(e).find("button").attr("disabled",!1),E(this).popover({title:E(this).attr("title"),content:e,html:!0}).popover("show").on("hidden.bs.popover",(function(){E(this).popover("dispose")}))}))}}const O=window.jQuery;class S extends b{constructor(t,e){super("console"),this.container=t,this.template=e||'<span class="date" data-format=\'dd.mm.yy G:i:s\'></span>\n            <span class="brick"></span>\n            <span class="code"></span>\n            <span class="text"></span>\n            <button>Quit</button>\n',this.alertViewMap=new Map}install(t){t.on("createalert",t=>this.createAlert(t)),t.on("removealert",t=>this.removeAlert(t))}createAlert(t){let e=O("function"==typeof this.template?this.template.call(this,t):this.template);const s=document.createElement("div");let r;O(s).html(e),O(s).find(".date").each((function(){if(!r){let e;r=(e=/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})$/i.exec(t.date))?new Date(e[1],e[2]-1,e[3],e[4],e[5],e[6]):new Date}O(this).html(window.Skyline.Date.format(O(this).attr("data-format")||"dd.mm.yyyy",r))})),O(s).find(".brick").html(t.brick),O(s).find(".code").html(t.code),O(s).find(".text").html(t.message);const i=this;O(s).find("button").on("click",(function(){i.visualizer.quitAlert(t.uid)})),s.className="report",0===t.level?s.classList.add("alert-secondary"):1===t.level?s.classList.add("alert-warning"):s.classList.add("alert-danger"),s.id="alert-"+t.uid,this.alertViewMap.set(t.uid,s),this.container.appendChild(s)}removeAlert(t){const e=this.alertViewMap.get(t.uid);e&&this.container.removeChild(e),this.alertViewMap.delete(t.uid)}}((t,e)=>{e||(e=window.Ikarus={}),Object.assign(e,{Visualizer:c,QuitEdit:f,Communication:g,APICommunication:v,Plugin:b,BrickStatusHandlerPlugin:C,BrickMasterStatusPlugin:T,BrickPanelPlugin:N,ValueEditionPlugin:k,ConsolePlugin:S}),t.fn.quikEdit=function(t){this.each((function(){this.quickEdit=new Ikarus.QuitEdit(this,t)}))}})(window.jQuery,window.Ikarus)}])}));