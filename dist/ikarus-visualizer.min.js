!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["ikarus-visualizer"]=e():t["ikarus-visualizer"]=e()}(window,(function(){return function(t){var e={};function s(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=t,s.c=e,s.d=function(t,e,r){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)s.d(r,i,function(e){return t[e]}.bind(null,i));return r},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class r{constructor(t){this.events=t instanceof r?t.events:t.handlers}on(t,e){return("string"==typeof t?t.split(" "):t).forEach(t=>{if(!this.events[t])throw new Error(`The event ${t} does not exist`);this.events[t].push(e)}),this}trigger(t,e){if(!(t in this.events))throw new Error(`The event ${t} cannot be triggered`);let s=!0,r=this;return this.events[t].forEach(t=>{"function"==typeof t&&(s=t.call(r,e)&&s)}),s}bind(t){if(this.events[t])throw new Error(`The event ${t} is already bound`);this.events[t]=[]}exists(t){return Array.isArray(this.events[t])}}class i extends r{constructor(t,e){super(e),this.id=t,this.components=new Map,this.plugins=new Map}use(t,e){if(t.name&&this.plugins.has(t.name))throw new Error(`Plugin ${t.name} already in use`);t.install(this,e||{}),this.plugins.set(t.name,e)}register(t){if(this.components.has(t.name))throw new Error(`Component ${t.name} already registered`);this.components.set(t.name,t),this.trigger("componentregister",t)}destroy(){this.trigger("destroy")}}class n extends class{constructor(t){this.handlers={warn:[console.warn],error:[console.error],componentregister:[],destroy:[],...t}}}{constructor(){super({fetch:[],beforeupdate:[],afterupdate:[],updatestatus:[],removealert:[],createalert:[],quitalert:[],sendcontrol:[],sentcontrol:[],sendcommand:[],sentcommand:[],sendvalue:[],sentvalue:[],callprocedure:[],procedurecalled:[],callworkflow:[],workflowcalled:[],openpanel:[],panelopened:[],closepanel:[],panelclosed:[]})}}class a{constructor(t,e,s,r,i,n){"string"!=typeof t&&([e,s,r,i,n]=[t.code,t.brick,t.message,t.date,t.level],t=t.uid),this.uid=t,this.code=e,this.brick=s,this.message=r,this.date=i,this.level=n,this.quitCallback=void 0}}class o{constructor(){this.map=new Map}append(t,e){this.map.set(t,e)}each(t){this.map.forEach(t)}get(t){return this.map.get(t)}}const l=window.jQuery;let c;const u={null:()=>"-.-",time_s:t=>t+"s",time_min:t=>window.Skyline.String.format("%d:%02d",Math.floor(t/60),t%60),time_h:t=>(t=Math.floor(t/60),window.Skyline.String.format("%d:%02d",Math.floor(t/60),t%60))};class d extends i{static get CONTROL_MANUAL_ON(){return"on"}static get CONTROL_MANUAL_OFF(){return"off"}static get CONTROL_MANUAL_AUTO(){return"auto"}static get STATUS_OFF(){return 1}static get STATUS_ON(){return 2}static get STATUS_ERROR(){return 4}static get STATUS_HAND_OFF(){return 8}static get STATUS_HAND_ON(){return 16}static get STATUS_PANEL(){return 32}static get STATUS_RESERVED_1(){return 64}static get STATUS_RESERVED_2(){return 128}static get mainVisualizer(){return c}static get formatters(){return u}use(t,e){super.use(t,e),t.visualizer=this}constructor(t,e,s,r){super(s,new n),this.interval=e,c=this,this.alertMap=new Map,this.communication=t,t.visualizer=this,this.errorReschedule=4*e,r&&this.updateFromCommunication(!0)}updateFromCommunication(t){if(!this.communication)throw new Error("Ikarus visualizer requires a communication instance.");let e=new o;this.communication.post("fetch",e).success(e=>{this.trigger("fetch",e),e.response&&this.updateFromJSON(e.response),t&&window.setTimeout(()=>this.updateFromCommunication(!0),this.interval)}).error(e=>{this.trigger("error",e),this.errorReschedule&&t&&window.setTimeout(()=>this.updateFromCommunication(!0),this.errorReschedule)})}updateFromJSON(t){if(this.trigger("beforeupdate",t)){if(!l)throw new Error("Ikarus visualizer requires jQuery component.");if(t.alerts)if(Object.keys(t.alerts).length>0){const e=[];for(const s in t.alerts){const r=t.alerts[s];if(r.uid&&(e.push(r.uid),!this.alertMap.has(r.uid))){const t=new a(r);this.alertMap.set(r.uid,t),this.trigger("createalert",t)}}this.alertMap.forEach(t=>{-1===e.indexOf(t.uid)&&(this.trigger("removealert",t),this.alertMap.delete(t.uid))})}else this.alertMap.forEach(t=>{this.trigger("removealert",t),this.alertMap.delete(t.uid)});for(const e in t)if(t.hasOwnProperty(e)){let s=t[e];if("@"===e.substr(0,1)){"1"===s?l("[data-visible='"+e.substr(1)+"']").addClass("visible"):l("[data-visible='"+e.substr(1)+"']").removeClass("visible");continue}const r=l("#"+e.replace(/\./gi,"--"));if(r.length<1||r.hasClass("editing"))continue;if(void 0!==s){if("string"==typeof s||"number"==typeof s){s=this.formatValue(s,r.attr("data-formatter"),r[0]),r.html(s);continue}"number"==typeof s.status&&(this.trigger("updatestatus",{anID:e,status:s.status,el:r[0]}),delete s.status);for(const t in s){const e=r.find("[data-ikey='"+t+"']");e.length>0&&!e.hasClass("editing")&&e.html(this.formatValue(s[t],e.attr("data-formatter"),e[0]))}}}this.trigger("afterupdate",t)}}formatValue(t,e,s){if(void 0!==e&&e.length){if("@"===e.charAt(0))return e=e.substr(1),"function"==typeof(e=u[e])?e(t,s):t;let r=1*l(s).attr("data-multiplyer");return r>1&&(t*=r),window.Skyline.String.format(e,t)}return t}sendControl(t,e){if(this.trigger("sendcontrol",t,e)){var s=new o;s.append("type",t),s.append("key",e),this.communication.post("ctl",s).success(t=>{this.trigger("sentcontrol",t)}).error(t=>{this.trigger("error",t)})}}sendCommand(t,e){if(this.trigger("sendcommand",t,e)){var s=new o;s.append("cmd",t),s.append("info",JSON.stringify(e||[])),this.communication.post("putc",s).success(t=>{this.trigger("sentcommand",t)}).error(t=>{this.trigger("error",t)})}}sendValue(t,e,s,r){if(!this.trigger("sendvalue",t,e))return;var i=new o;i.append("value",t);let[n,a]=e.split("--",2);("string"!=typeof a||a.length<1)&&(a=n,n=this.communication.domain.split(" ",2)[0]),i.append("key",a),i.append("domain",n),this.communication.post("putv",i).success(e=>{this.trigger("sentvalue",e?e.value:t),s&&s(e?e.value:t)}).error(t=>{this.trigger("error",t),r&&r(t)})}callProcedure(t,e){if(this.trigger("callprocedure",t,e)){var s=new o;s.append("name",t),e&&s.append("arguments",JSON.stringify(e)),this.communication.post("cproc",s).success(t=>{this.trigger("procedurecalled",t)}).error(t=>{this.trigger("error",t)})}}callWorkflow(t){if(this.trigger("callworkflow",t)){var e=new o;e.append("name",t),this.communication.post("cwfl",e).success(t=>{this.trigger("workflowcalled",t)}).error(t=>{this.trigger("error",t)})}}quitAlert(t){var e=new o;e.append("key",t),this.communication.post("alrtq",e).success(e=>{this.trigger("quitalert",e);const s=this.alertMap.get(t instanceof a?t.uid:t);"function"==typeof s.quitCallback&&s.quitCallback.call(s,e)}).error(t=>{this.trigger("error",t)})}openPanel(t){this.trigger("openpanel",t);var e=new o;e.append("brick",t),this.communication.post("po",e).success(t=>{this.trigger("panelopened",t)}).error(t=>{this.trigger("error",t)})}closePanel(t){this.trigger("closepanel",t);var e=new o;e.append("brick",t),this.communication.post("co",e).success(t=>{this.trigger("panelclosed",t)}).error(t=>{this.trigger("error",t)})}}const h={def:function(){return m(this).text()}},p={def:function(t,e){m(this).html(t)}},m=window.jQuery;let f=2500;class g{static get editableTagReaders(){return h}static get editableTagWriters(){return p}static get EDITOR_CHANGE_INTERVAL(){return f}static set EDITOR_CHANGE_INTERVAL(t){f=t}constructor(t,e){this.$element=m(t),this.$element.addClass("value-editable active"),this.visualizer=e||d.mainVisualizer;const s=()=>{this.$element.removeClass("editing");let e=g.editableTagWriters[this.$element[0].tagName.toLowerCase()];e||(e=g.editableTagWriters.def),e.call(t,this.oldValue,!1)};this.$element.on("dblclick touch",()=>{this.$element.addClass("editing");let e=g.editableTagReaders[this.$element[0].tagName.toLowerCase()];e||(e=g.editableTagReaders.def),this.oldValue=e.call(t);let s=this.$element.attr("data-editable");s=s||"text",this.$element.html("<input type='"+s+"' value='"+this.oldValue+"'>"),this.$element.find("input").focus()}).on("change",()=>{this.$element.removeClass("editing");var e=this.$element.find("input").val(),s=this.$element.attr("id");let r=g.editableTagWriters[this.$element[0].tagName.toLowerCase()];r||(r=g.editableTagWriters.def);let i=()=>{this.$element.removeClass("sending").addClass("error"),window.setTimeout(()=>{this.$element.removeClass("error")},g.EDITOR_CHANGE_INTERVAL),r.call(t,this.oldValue,!1)},n=e=>{this.$element.removeClass("sending").addClass("success"),window.setTimeout(()=>{this.$element.removeClass("success")},g.EDITOR_CHANGE_INTERVAL),void 0!==e?r.call(t,e,!0):r.call(t,"",!1)};if(s){this.$element.addClass("sending");let t=this.$element.attr("data-emultiplyer");t&&(e*=t),this.visualizer.sendValue(e,s,n,i)}else console.error("Can not put value without attribute id",this.$element[0]),i();this.$element.blur()}).on("focusout",()=>{s()}).on("keyup",t=>{27===(t.which||t.keyCode)&&s()})}}class w{constructor(){this.errorFN=[],this.successFN=[]}success(t){return this.successFN.push(t),this}error(t){this.errorFN.push(t)}completed(t){t?this.successFN.forEach(t=>t()):this.errorFN.forEach(t=>t())}}class v{post(t,e){}}class b extends v{constructor(t,e){super(),this.domain=e,this.targetURL=t}post(t,e){e.append("domain",this.domain),e.append("command",t);const s=new FormData;return e.each((t,e)=>s.append(e,t)),"fetch"===t?window.Skyline.API.get(this.targetURL+"?fetch&domain="+encodeURIComponent(this.domain)):window.Skyline.API.post(this.targetURL,s)}}class y{constructor(){this._success=[],this._error=[]}success(t){return this._success.push(t),this}succeeded(t){this._success.forEach(e=>e(t)),this._success=[]}failed(t){this._error.forEach(e=>e(t)),this._error=[]}error(t){return this._error.push(t),this}}class S extends v{constructor(t,e){super(),this.domain=e,this.ready=0,this.stack=[],this.msg={response:{}},this.socket=new WebSocket(t,"IKARUS_HOOK"),this.socket.onmessage=t=>{this.ready=1,this.postMessage(JSON.parse(t.data))},this.socket.onerror=t=>{this.ready=-1,this.visualizer.trigger("error",t)},this.socket.onopen=()=>{this.ready=1,this.socket.send("HOOK "+JSON.stringify([[],[],[],e])),this.visualizer.trigger("fetch",{conn_stat:"WebSocket",conn_msg:"Verbindung läuft über "+t+"."})},this.socket.onclose=()=>{this.ready=-1,this.visualizer.trigger("error",{title:"WebSocket",message:"Die Verbindung zum Speicherregister wurde unterbrochen."})}}postMessage(t){if(this.msg=t,t.hasOwnProperty("D")&&(t=t.D),"boolean"==typeof t){const e=this.stack.shift();t?e.succeeded(t):e.failed(t)}else this.visualizer&&this.visualizer.updateFromJSON(t)}postError(t){const e=this.stack.shift();e&&e.failed(t)}pushStack(t,e){this.stack.push(t),window.setTimeout(()=>{if(this.stack[0]===t){this.stack.shift();console.warn("Anfrage ist abgelaufen.",t)}},e)}post(t,e){if(0===this.ready){const t=this.msg;return{success(e){return window.setTimeout(()=>e(t),100),this},error(t){return this}}}if(-1===this.ready){this.msg;return{success(t){return this},error(t){return window.setTimeout(()=>t({title:"Verbinden fehlgeschlagen:",message:"Ikarus SPS Speicherregister kann nicht erreicht werden."}),100),this}}}let s=void 0;switch(t){case"fetch":return{success(){return this},error(){return this}};default:s=new y;const r={};e.each((t,e)=>r[e]=t),t=t+" "+JSON.stringify(r),this.socket.send(t),this.pushStack(s,100)}return s}}class k{get name(){return""}install(t,e){}}const C=window.jQuery;class _ extends k{install(t,e){t.on("updatestatus",({anID:t,status:e,el:s})=>this.statusHandler(t,e,s))}statusHandler(t,e,s){const r=C(s);r.removeClass("status-on").removeClass("status-off").removeClass("status-hand").removeClass("status-res-1").removeClass("status-res-2").removeClass("status-panel").removeClass("status-err"),e&d.STATUS_OFF&&r.addClass("status-off"),e&d.STATUS_ON&&r.addClass("status-on"),e&d.STATUS_ERROR&&r.addClass("status-err"),e&d.STATUS_HAND_OFF&&r.addClass("status-hand").addClass("status-off").removeClass("status-on"),e&d.STATUS_HAND_ON&&r.addClass("status-hand").addClass("status-on").removeClass("status-off"),e&d.STATUS_PANEL&&r.addClass("status-panel"),e&d.STATUS_RESERVED_1&&r.addClass("status-res-1"),e&d.STATUS_RESERVED_2&&r.addClass("status-res-2")}get name(){return"status-handler"}}class T extends _{statusHandler(t,e,s){const r=s=>{super.statusHandler(t,e&~d.STATUS_HAND_ON&~d.STATUS_HAND_OFF,s)};$(s).parent().find(".brick[data-master='"+t+"']").each((function(){r(this)}))}}const A=window.jQuery;class E extends k{install(t,e){if(!A)throw new Error("Can not install value edition plugin without jQuery installed before.");A("span[data-editable]").each((function(){this.value_editor=new g(this,t)}))}}const O=window.jQuery,N={pw_prompt:"Please enter the password to confirm the action:",pw_denied:"Action not sent: Password is wrong"};class R extends k{install(t,e){if(e=O.extend({},N,e||{}),!O)throw new Error("Can not install brick panel plugin without jQuery installed before.");const s=this;O(".brick[data-panel]").on("click",(function(){void 0!==s.current_panel&&(s.current_panel.popover("hide"),s.current_panel=void 0);let e=O("#"+O(this).attr("data-panel")).html();e=e.replace(/&amp;id;/gi,O(this).attr("id")),e=e.replace(/&amp;info;/gi,O(this).attr("data-info")),e=e.replace(/&amp;domain;/gi,O(this).attr("data-domain")),e+=' <button type="button" onclick="$(this).parent().parent().popover(\'hide\')" class="close" style="position: absolute; top: 0.25rem; right: 0.25rem" aria-label="Close">\n  <span aria-hidden="true">&times;</span>\n</button>';const r=this.id;e=O(e),e.find("button[data-control]").on("click",(function(){t.sendControl(O(this).attr("data-control"),r)}));const i=t=>{t&&0!==t.length||(t="{}");const e=JSON.parse(t);return e.brick=r,JSON.stringify(e)};e.find("button[data-command]").on("click",(function(){let e=i(O(this).attr("data-arguments"));t.sendCommand(O(this).attr("data-command"),e)})),e.find("button[data-procedure]").on("click",(function(){let e=i(O(this).attr("data-arguments"));t.callProcedure(O(this).attr("data-procedure"),e)})),O(e).find("button").attr("disabled","disabled"),(O(this).hasClass("status-on")||O(this).hasClass("status-off"))&&O(e).find("button").attr("disabled",!1),s.current_panel=O(this).popover({title:O(this).attr("title"),content:e,html:!0}).popover("show").on("hidden.bs.popover",(function(){O(this).popover("dispose"),t.closePanel(r)})),t.openPanel(r)}))}}const M=window.jQuery;class P extends k{constructor(t,e){super("console"),this.container=t,this.template=e||'<span class="date" data-format=\'dd.mm.yy G:i:s\'></span>\n            <span class="brick"></span>\n            <span class="code"></span>\n            <span class="text"></span>\n            <button>Quit</button>\n',this.alertViewMap=new Map}install(t){t.on("createalert",t=>this.createAlert(t)),t.on("removealert",t=>this.removeAlert(t))}createAlert(t){let e=M("function"==typeof this.template?this.template.call(this,t):this.template);const s=document.createElement("div");let r;M(s).html(e),M(s).find(".date").each((function(){if(!r){let e;r=(e=/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})$/i.exec(t.date))?new Date(e[1],e[2]-1,e[3],e[4],e[5],e[6]):new Date}M(this).html(window.Skyline.Date.format(M(this).attr("data-format")||"dd.mm.yyyy",r))})),M(s).find(".brick").html(t.brick),M(s).find(".code").html(t.code),M(s).find(".text").html(t.message);const i=this;M(s).find("button").on("click",(function(){i.visualizer.quitAlert(t.uid)})),s.className="report",console.log(t.level),1===t.level?s.classList.add("alert-secondary"):2===t.level?s.classList.add("alert-warning"):s.classList.add("alert-danger"),s.id="alert-"+t.uid,this.alertViewMap.set(t.uid,s),this.container.appendChild(s)}removeAlert(t){console.log("REMOVE "+t.uid);const e=this.alertViewMap.get(t.uid);e&&this.container.removeChild(e),this.alertViewMap.delete(t.uid)}}((t,e)=>{e||(e=window.Ikarus={}),Object.assign(e,{Visualizer:d,QuitEdit:g,Communication:v,APICommunication:b,WebSocketCommunication:S,CommunicationInstance:w,Plugin:k,BrickStatusHandlerPlugin:_,BrickMasterStatusPlugin:T,BrickPanelPlugin:R,ValueEditionPlugin:E,ConsolePlugin:P}),t.fn.quikEdit=function(t){this.each((function(){this.quickEdit=new Ikarus.QuitEdit(this,t)}))}})(window.jQuery,window.Ikarus)}])}));